<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Respuestas MercadoLibre</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #app {
            width: 400px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #4CAF50;
        }
        input, textarea, button {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #status, #debug {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
        #status {
            color: #4CAF50;
        }
        #debug {
            color: #333;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="app">
        <h2>Asistente de Respuestas MercadoLibre</h2>
        <input type="text" id="question" placeholder="Ingrese la pregunta">
        <textarea id="answer" placeholder="Respuesta sugerida"></textarea>
        <button onclick="getAnswer()">Obtener Respuesta</button>
        <button onclick="copyAndLearn()">Copiar y Aprender Respuesta</button>
        <div id="status"></div>
        <div id="debug"></div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA9GK6IVhl5TfFZ-DsQ5mGnIofk_mFeJtM",
            authDomain: "asistente-ml.firebaseapp.com",
            databaseURL: "https://asistente-ml-default-rtdb.firebaseio.com/",
            projectId: "asistente-ml",
            storageBucket: "asistente-ml.appspot.com",
            messagingSenderId: "583339158222",
            appId: "1:583339158222:web:694da526ea7fee919f3e9f"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let questions = {};

        // Cargar preguntas desde Firebase
        function loadQuestions() {
            database.ref('questions').on('value', (snapshot) => {
                questions = snapshot.val() || {};
            });
        }

        // Cargar preguntas al iniciar
        loadQuestions();

        // Función para obtener respuesta del backend
        async function getAnswer() {
            const question = document.getElementById('question').value.trim();
            if (!question) {
                alert('Por favor, ingrese una pregunta.');
                return;
            }

            const debugElement = document.getElementById('debug');
            debugElement.innerHTML = 'Enviando solicitud al backend...';

            try {
                const response = await axios.post('https://asistente-ml.onrender.com/get-custom-gpt-response', { 
                    question: question,
                    history: Object.entries(questions).map(([q, a]) => ({ question: q, answer: a }))
                });

                debugElement.innerHTML += '<br>Respuesta recibida del backend.';
                console.log('Respuesta completa del backend:', response.data);

                if (response.data && response.data.answer) {
                    document.getElementById('answer').value = response.data.answer;
                    debugElement.innerHTML += '<br>Respuesta GPT aplicada correctamente.';
                } else {
                    throw new Error('La respuesta del backend no contiene una respuesta válida.');
                }
            } catch (error) {
                console.error('Error detallado:', error);
                debugElement.innerHTML += `<br>Error: ${error.message}`;
                if (error.response) {
                    console.log('Datos de respuesta de error:', error.response.data);
                    console.log('Estado de error:', error.response.status);
                    debugElement.innerHTML += `<br>Estado de error: ${error.response.status}`;
                }
                alert('Error al obtener la respuesta. Por favor, revise la consola y el área de depuración para más detalles.');
            }
        }

        // Función para copiar y aprender la respuesta
        async function copyAndLearn() {
            const question = document.getElementById('question').value.trim();
            const answer = document.getElementById('answer').value.trim();
            
            if (question && answer && answer !== "Lo siento, no tengo una respuesta para esta pregunta. Por favor, ingresa una respuesta adecuada.") {
                try {
                    // Guardar en Firebase
                    await database.ref('questions/' + question).set(answer);

                    // Copiar al portapapeles
                    await navigator.clipboard.writeText(answer);
                    
                    // Actualizar el estado
                    document.getElementById('status').textContent = 'Respuesta copiada y aprendida';
                    setTimeout(() => {
                        document.getElementById('status').textContent = '';
                    }, 3000);

                    // Actualizar las preguntas locales
                    questions[question] = answer;
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al guardar o copiar la respuesta');
                }
            } else {
                alert('Por favor, ingrese tanto la pregunta como una respuesta válida');
            }
        }
    </script>
</body>
</html>
