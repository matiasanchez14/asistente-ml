<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Respuestas MercadoLibre</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* ... (mantén los estilos anteriores) ... */
    </style>
</head>
<body>
    <div id="app">
        <h2>Asistente de Respuestas MercadoLibre</h2>
        <input type="text" id="question" placeholder="Ingrese la pregunta">
        <textarea id="answer" placeholder="Respuesta sugerida"></textarea>
        <button onclick="copyAndLearn()">Copiar y Aprender Respuesta</button>
        <div id="status"></div>
    </div>

    <script>
        // Configuración de Firebase (reemplaza con tus propias credenciales)
        const firebaseConfig = {
            apiKey: "AIzaSyA9GK6IVhl5TfFZ-DsQ5mGnIofk_mFeJtM",
            authDomain: "asistente-ml.firebaseapp.com",
            databaseURL: "https://asistente-ml-default-rtdb.firebaseio.com/",
            projectId: "asistente-ml",
            storageBucket: "asistente-ml.appspot.com",
            messagingSenderId: "583339158222",
            appId: "1:583339158222:web:694da526ea7fee919f3e9f"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let questions = {};

        // Cargar preguntas desde Firebase
        function loadQuestions() {
            database.ref('questions').on('value', (snapshot) => {
                questions = snapshot.val() || {};
            });
        }

        function loadQuestions() {
            database.ref('questions').on('value', (snapshot) => {
                questions = snapshot.val() || {};
            });
        }

        // Cargar preguntas al iniciar
        loadQuestions();

        // Función para procesar el texto
        function processText(text) {
            return text.toLowerCase()
                .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
                .replace(/\s+/g, " ")
                .trim();
        }

        // Función para extraer palabras clave
        function extractKeywords(text) {
            const stopWords = new Set(["el", "la", "los", "las", "un", "una", "unos", "unas", "y", "o", "pero", "si", "no", "en", "de", "a", "con", "por", "para", "como", "se", "su", "sus", "este", "esta", "estos", "estas", "ese", "esa", "esos", "esas", "aquel", "aquella", "aquellos", "aquellas"]);
            return processText(text)
                .split(" ")
                .filter(word => !stopWords.has(word) && word.length > 2);
        }

        // Función para calcular la similitud entre dos conjuntos de palabras clave
        function calculateSimilarity(keywords1, keywords2) {
            const set1 = new Set(keywords1);
            const set2 = new Set(keywords2);
            const intersection = new Set([...set1].filter(x => set2.has(x)));
            const union = new Set([...set1, ...set2]);
            return intersection.size / union.size;
        }

        // Evento de entrada para la pregunta
        document.getElementById('question').addEventListener('input', function() {
            const question = this.value;
            const processedQuestion = processText(question);
            const keywords = extractKeywords(processedQuestion);
            let bestMatch = '';
            let highestSimilarity = 0;

            for (let key in questions) {
                const keyKeywords = extractKeywords(key);
                const similarity = calculateSimilarity(keywords, keyKeywords);
                if (similarity > highestSimilarity) {
                    highestSimilarity = similarity;
                    bestMatch = key;
                }
            }

            if (highestSimilarity > 0.3) { // Umbral ajustado para mayor flexibilidad
                document.getElementById('answer').value = questions[bestMatch];
            } else {
                document.getElementById('answer').value = "Lo siento, no tengo una respuesta para esta pregunta. Por favor, ingresa una respuesta adecuada.";
            }
        });

        // Función para copiar y aprender la respuesta
        async function copyAndLearn() {
            const question = document.getElementById('question').value.trim();
            const answer = document.getElementById('answer').value.trim();
            
            if (question && answer && answer !== "Lo siento, no tengo una respuesta para esta pregunta. Por favor, ingresa una respuesta adecuada.") {
                try {
                    // Guardar en Firebase
                    await database.ref('questions/' + question).set(answer);

                    // Copiar al portapapeles
                    await navigator.clipboard.writeText(answer);
                    
                    // Actualizar el estado
                    document.getElementById('status').textContent = 'Respuesta copiada y aprendida';
                    setTimeout(() => {
                        document.getElementById('status').textContent = '';
                    }, 3000);

                    // Actualizar las preguntas locales
                    questions[question] = answer;
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al guardar o copiar la respuesta');
                }
            } else {
                alert('Por favor, ingrese tanto la pregunta como una respuesta válida');
            }
        }
    </script>
</body>
</html>
